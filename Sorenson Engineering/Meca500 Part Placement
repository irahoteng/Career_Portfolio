//// This shows a snippet of how the Meca500 detects and places parts in a pallet
SWITCH (movementState):
    CASE 0:
        IF Execute is TRUE:
            movementState = 5

    CASE 5:  // Set part insertion height
        palletPosition[3] = partHeightFromRecipe
        movementState = 10

    CASE 10:  // Request coordinates from vision system
        IF vision.getPartDone is FALSE AND systemState == 1:
            vision.getPart(arrPartPos)
        IF vision.getPartDone is TRUE:
            vision.getPartDone = FALSE
            movementState = 15

    CASE 15:  // Transform coordinates to robot frame
        IF vision.transformDone is FALSE:
            vision.transformCoordinates(arrPartPos)
        IF vision.transformDone is TRUE:
            grabPosition.X = arrPartPos[1]
            grabPosition.Y = arrPartPos[2]
            grabPosition.Rz = arrPartPos[3]
            vision.transformDone = FALSE
            movementState = 20

    CASE 20:  // Move robot to pick up part
        robot.grabPart(grabPosition)
        IF robot.Done:
            movementState = 25
        IF robot is paused:
            airControl = OFF

    CASE 25:  // Move up and check if part is held
        robot.clearPath()
        IF robot.Done AND partNotHeld:
            movementState = 0  // Retry
        ELSE IF robot.Done:
            movementState = 30

    CASE 30:  // Insert part onto pallet
        robot.insertPart(palletPosition)
        IF robot.Done:
            airControl = OFF
            movementState = 35

    CASE 35:  // Delay before restarting loop
        startDelay(0.2 seconds)
        IF delayComplete:
            movementState = 40

    CASE 40:  // Prepare for next cycle
         stopDelay()
    movementState = 0

    // Move to next pallet hole in Y-direction
    palletPosition.Y = palletPosition.Y - 10

    // Check if we've reached the end of the current row
    IF palletPosition.Y <= -240:
        palletPosition.Y = initialY        // Reset Y to the first column
        palletPosition.X = palletPosition.X - 10  // Move to next row (X-direction)
        movementState = 45

    CASE 45:  // Check if pallet is full
        movementState = 0
        IF palletPosition.X <= 70:
            stopOperation = TRUE
            movementState = 100
            palletFull = TRUE

    CASE 100:  // Stop execution
        IF palletFull:
            Execute = FALSE

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
//This shows how a part is detected or whether not it has been placed already
(*  part detected*)
IF partDetected == 1:
    PartVacuumed = TRUE
ELSE:
    PartVacuumed = FALSE

// Check if part was placed based on flow rate
IF actualFlow <= flowThreshold:
    InsertedInPallet = TRUE
ELSE:
    InsertedInPallet = FALSE
